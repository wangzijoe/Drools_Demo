<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">Chapter 2. User Guide</title><link rel="stylesheet" href="css/jbossorg.css" type="text/css"/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL-NS Stylesheets V1.74.0"/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" http-equiv="Content-Type" content="text/html; charset=UTF-8"/><link rel="home" href="index.html" title="Drools Expert User Guide"/><link rel="up" href="index.html" title="Drools Expert User Guide"/><link rel="prev" href="ch01.html" title="Chapter 1. Introduction"/><link rel="next" href="ch03.html" title="Chapter 3. API Reference"/></head><body><p xmlns:d="http://docbook.org/ns/docbook" id="title"><a href="http://www.jboss.org" class="site_href"><strong>JBoss.org</strong></a><a href="http://docs.jboss.org/" class="doc_href"><strong>Community Documentation</strong></a></p><ul xmlns:d="http://docbook.org/ns/docbook" class="docnav"><li class="previous"><a accesskey="p" href="ch01.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="ch03.html"><strong>Next</strong></a></li></ul><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e584"/>Chapter 2. User Guide</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="ch02.html#d0e587">2.1. The Basics</a></span></dt><dd><dl><dt><span class="section"><a href="ch02.html#d0e590">2.1.1. Stateless Knowledge Session</a></span></dt><dt><span class="section"><a href="ch02.html#d0e737">2.1.2. Stateful Knowledge Session</a></span></dt><dt><span class="section"><a href="ch02.html#d0e909">2.1.3. Methods versus Rules</a></span></dt><dt><span class="section"><a href="ch02.html#d0e941">2.1.4. Cross Products</a></span></dt></dl></dd><dt><span class="section"><a href="ch02.html#d0e966">2.2. Inference</a></span></dt><dd><dl><dt><span class="section"><a href="ch02.html#d0e969">2.2.1. Buss Pass Example</a></span></dt></dl></dd><dt><span class="section"><a href="ch02.html#d0e1037">2.3. Truth Maintenance with  Logical Objects</a></span></dt><dd><dl><dt><span class="section"><a href="ch02.html#d0e1044">2.3.1. Overview</a></span></dt></dl></dd><dt><span class="section"><a href="ch02.html#d0e1157">2.4. Decision Tables in Spreadsheets</a></span></dt><dd><dl><dt><span class="section"><a href="ch02.html#d0e1169">2.4.1. When to Use Decision Tables</a></span></dt><dt><span class="section"><a href="ch02.html#d0e1187">2.4.2. Overview</a></span></dt><dt><span class="section"><a href="ch02.html#d0e1225">2.4.3. How Decision Tables Work</a></span></dt><dt><span class="section"><a href="ch02.html#d0e1309">2.4.4. Spreadsheet Syntax</a></span></dt><dt><span class="section"><a href="ch02.html#d0e1821">2.4.5. Creating and integrating Spreadsheet based Decision Tables</a></span></dt><dt><span class="section"><a href="ch02.html#d0e1840">2.4.6. Managing Business Rules in Decision Tables</a></span></dt><dt><span class="section"><a href="ch02.html#d0e1885">2.4.7. Rule Templates</a></span></dt></dl></dd><dt><span class="section"><a href="ch02.html#d0e1972">2.5. Templates</a></span></dt><dd><dl><dt><span class="section"><a href="ch02.html#d0e1985">2.5.1. The Rule Template File</a></span></dt><dt><span class="section"><a href="ch02.html#d0e2081">2.5.2. Expanding a Template</a></span></dt><dt><span class="section"><a href="ch02.html#d0e2137">2.5.3. Example</a></span></dt></dl></dd><dt><span class="section"><a href="ch02.html#d0e2208">2.6. More on building and deploying</a></span></dt><dd><dl><dt><span class="section"><a href="ch02.html#d0e2211">2.6.1. Knowledge Base by Configuration Using Changesets</a></span></dt><dt><span class="section"><a href="ch02.html#d0e2239">2.6.2. Knowledge Agent</a></span></dt></dl></dd><dt><span class="section"><a href="ch02.html#d0e2310">2.7. Logging</a></span></dt></dl></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e587"/>2.1. The Basics</h2></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e590"/>2.1.1. Stateless Knowledge Session</h3></div></div></div><p>So where do we get started? There are so many use cases and so much
    functionality in a rule engine such as Drools that it becomes beguiling.
    Have no fear my intrepid adventurer, the complexity is layered and you can
    ease yourself into with simple use cases.</p><p>Stateless session, not utilising inference, forms the simplest use
    case. A stateless session can be called like a function passing it some
    data and then receiving some results back. Some common use cases for
    stateless sessions are, but not limited to:</p><div class="itemizedlist"><ul><li><p>Validation</p><div class="itemizedlist"><ul><li><p>Is this person eligible for a mortgage?</p></li></ul></div></li><li><p>Calculation</p><div class="itemizedlist"><ul><li><p>Compute a mortgage premium.</p></li></ul></div></li><li><p>Routing and Filtering</p><div class="itemizedlist"><ul><li><p>Filter incoming messages, such as emails, into
            folders.</p></li><li><p>Send incoming messages to a destination.</p></li></ul></div></li></ul></div><p>So let's start with a very simple example using a driving license
    application.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Applicant</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;age</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;valid</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;getter&nbsp;and&nbsp;setter&nbsp;methods&nbsp;here</span>
<!--  --><br/><span class="java_separator">}</span>
</pre><p>Now that we have our data model we can write our first rule. We
    assume that the application uses rules to reject invalid applications. As
    this is a simple validation use case we will add a single rule to
    disqualify any applicant younger than 18.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">package com.company.license

rule "Is of valid age"
when
    $a : Applicant( age &lt; 18 )
then
    $a.setValid( false );
end</pre><p>To make the engine aware of data, so it can be processed against the
    rules, we have to <span class="emphasis"><em>insert</em></span> the data, much like with a
    database. When the Applicant instance is inserted into the engine it is
    evaluated against the constraints of the rules, in this case just two
    constraints for one rule. We say <span class="emphasis"><em>two</em></span> because the type
    Applicant is the first object type constraint, and <code class="code">age &lt;
    18</code> is the second field constraint. An object type constraint plus
    its zero or more field constraints is referred to as a pattern. When an
    inserted instance satisfies both the object type constraint and all the
    field constraints, it is said to be matched. The <code class="code">$a</code> is a
    binding variable which permits us to reference the matched object in the
    consequence. There its properties can be updated. The dollar character
    ('$') is optional, but it helps to differentiate variable names from field
    names. The process of matching patterns against the inserted data is, not
    surprisingly, often referred to as <span class="emphasis"><em>pattern
    matching</em></span>.</p><p>Let's assume that the rules are in the same folder as the classes,
    so we can use the classpath resource loader to build our first
    <code class="code">KnowledgeBase</code>. A Knowledge Base is what we call our
    collection of compiled definitions, such as rules and processes, which are
    compiled using the <code class="code">KnowledgeBuilder</code>. Both the
    KnowledgeBuilder and KnowledgeBase can be created from the factories
    KnowledgeBuilderFactory and KnowledgeBaseFactory.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeBuilder</span><!-- <br/> --><span class="java_plain">&nbsp;kbuilder&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeBuilderFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeBuilder</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">kbuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newClassPathResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;licenseApplication.drl&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getClass</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DRL&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">hasErrors</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">err</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">getErrors</span><span class="java_separator">().</span><span class="java_plain">toString</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBase</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">kbase</span><span class="java_separator">.</span><span class="java_plain">addKnowledgePackages</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">getKnowledgePackages</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span></pre><p>The above code snippet looks on the classpath for the
    <code class="filename">licenseApplication.drl</code> file, using the method
    <code class="code">newClassPathResource()</code>. The resource type is DRL, short for
    "Drools Rule Language". Once the DRL file has been added we can check the
    Knowledge Builder object for any errors. If there are no errors, we can
    add the resulting packages to our Knowledge Base. Now we are ready to
    build our session and execute against some data:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">StatelessKnowledgeSession</span><!-- <br/> --><span class="java_plain">&nbsp;ksession&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;kbase</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newStatelessKnowledgeSession</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Applicant</span><span class="java_plain">&nbsp;applicant&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Applicant</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Mr&nbsp;John&nbsp;Smith&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">16</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">assertTrue</span><span class="java_separator">(</span><span class="java_plain">&nbsp;applicant</span><span class="java_separator">.</span><span class="java_plain">isValid</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">execute</span><span class="java_separator">(</span><span class="java_plain">&nbsp;applicant&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">assertFalse</span><span class="java_separator">(</span><span class="java_plain">&nbsp;applicant</span><span class="java_separator">.</span><span class="java_plain">isValid</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</pre><p>The preceding code executes the data against the rules. Since the
    applicant is under the age of 18, the application is marked as
    invalid.</p><p>So far we've only used a single instance, but what if we want to use
    more than one? We can execute against any object implementing Iterable,
    such as a collection. Let's add another class called
    <code class="code">Application</code>, which has the date of the application, and we'll
    also move the boolean valid field to the <code class="code">Application</code>
    class.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Applicant</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;age</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;getter&nbsp;and&nbsp;setter&nbsp;methods&nbsp;here</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Application</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Date</span><span class="java_plain">&nbsp;dateApplied</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;valid</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;getter&nbsp;and&nbsp;setter&nbsp;methods&nbsp;here</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>We can also add another rule to validate that the application was
    made within a period of time.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">package com.company.license

rule "Is of valid age"
when
    Applicant( age &lt; 18 )
    $a : Application()     
then
    $a.setValid( false );
end

rule "Application was made this year"
when
    $a : Application( dateApplied &gt; "01-jan-2009" )     
then
    $a.setValid( false );
end
</pre><p>Unfortunately a Java array does not implement the
    <code class="code">Iterable</code> interface, so we have to use the JDK converter
    method <code class="code">Arrays.asList(...)</code>. The code shown below executes
    against an iterable list, where all collection elements are inserted
    before any matched rules are fired.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">StatelessKnowledgeSession</span><!-- <br/> --><span class="java_plain">&nbsp;ksession&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;kbase</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newStatelessKnowledgeSession</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Applicant</span><span class="java_plain">&nbsp;applicant&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Applicant</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Mr&nbsp;John&nbsp;Smith&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">16</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Application</span><span class="java_plain">&nbsp;application&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Application</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">assertTrue</span><span class="java_separator">(</span><span class="java_plain">&nbsp;application</span><span class="java_separator">.</span><span class="java_plain">isValid</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">execute</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Arrays</span><span class="java_separator">.</span><span class="java_plain">asList</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;application</span><span class="java_separator">,</span><span class="java_plain">&nbsp;applicant&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">assertFalse</span><span class="java_separator">(</span><span class="java_plain">&nbsp;application</span><span class="java_separator">.</span><span class="java_plain">isValid</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</pre><p>The two execute methods <code class="code">execute(Object object)</code> and
    <code class="code">execute(Iterable objects)</code> are actually convenience methods
    for the interface <code class="code">BatchExecutor</code>'s method
    <code class="code">execute(Command command)</code>.</p><p>A <code class="code">CommandFactory</code> is used to create commands, so that
    the following is equivalent to <code class="code">execute(Iterable it)</code>:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">ksession</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">execute</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">CommandFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newInsertIterable</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Object</span><!-- <br/> --><span class="java_separator">[]</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span><!-- <br/> --><span class="java_plain">&nbsp;application</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;applicant&nbsp;</span><!-- <br/> --><span class="java_separator">}</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
</pre><p>Batch Executor and Command Factory are particularly useful when
    working with multiple Commands and with output identifiers for obtaining
    results.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">List</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">Command</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;cmds&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">ArrayList</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">Command</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">cmds</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">CommandFactory</span><span class="java_separator">.</span><span class="java_plain">newInsert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Person</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Mr&nbsp;John&nbsp;Smith&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;mrSmith&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">cmds</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">CommandFactory</span><span class="java_separator">.</span><span class="java_plain">newInsert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Person</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Mr&nbsp;John&nbsp;Doe&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;mrDoe&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">BatchExecutionResults</span><span class="java_plain">&nbsp;results&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">execute</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">CommandFactory</span><span class="java_separator">.</span><span class="java_plain">newBatchExecution</span><span class="java_separator">(</span><span class="java_plain">&nbsp;cmds&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">assertEquals</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Person</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Mr&nbsp;John&nbsp;Smith&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;results</span><span class="java_separator">.</span><span class="java_plain">getValue</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;mrSmith&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</pre><p><code class="code">CommandFactory</code> supports many other Commands that can be
    used in the <code class="code">BatchExecutor</code> like <code class="code">StartProcess</code>,
    <code class="code">Query</code>, and <code class="code">SetGlobal</code>.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e737"/>2.1.2. Stateful Knowledge Session</h3></div></div></div><p>Stateful Sessions are longer lived and allow iterative changes over
    time. Some common use cases for Stateful Sessions are, but not limited
    to:</p><div class="itemizedlist"><ul><li><p>Monitoring</p><div class="itemizedlist"><ul><li><p>Stock market monitoring and analysis for semi-automatic
            buying.</p></li></ul></div></li><li><p>Diagnostics</p><div class="itemizedlist"><ul><li><p>Fault finding, medical diagnostics</p></li></ul></div></li><li><p>Logistics</p><div class="itemizedlist"><ul><li><p>Parcel tracking and delivery provisioning</p></li></ul></div></li><li><p>Compliance</p><div class="itemizedlist"><ul><li><p>Validation of legality for market trades.</p></li></ul></div></li></ul></div><p>In contrast to a Stateless Session, the <code class="code">dispose()</code>
    method must be called afterwards to ensure there are no memory leaks, as
    the Knowledge Base contains references to Stateful Knowledge Sessions when
    they are created. <code class="code">StatefulKnowledgeSession</code> also supports the
    <code class="code">BatchExecutor</code> interface, like
    <code class="code">StatelessKnowledgeSession</code>, the only difference being that the
    <code class="code">FireAllRules</code> command is not automatically called at the end
    for a Stateful Session.</p><p>We illustrate the monitoring use case with an example for raising a
    fire alarm. Using just four classes, we represent rooms in a house, each
    of which has one sprinkler. If a fire starts in a room, we represent that
    with a single <code class="code">Fire</code> instance.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Room</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;getter&nbsp;and&nbsp;setter&nbsp;methods&nbsp;here</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Sprinkler</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Room</span><span class="java_plain">&nbsp;room</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;on</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;getter&nbsp;and&nbsp;setter&nbsp;methods&nbsp;here</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Fire</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Room</span><span class="java_plain">&nbsp;room</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;getter&nbsp;and&nbsp;setter&nbsp;methods&nbsp;here</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Alarm</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_separator">}</span>
</pre><p>In the previous section on Stateless Sessions the concepts of
    inserting and matching against data were introduced. That example assumed
    that only a single instance of each object type was ever inserted and thus
    only used literal constraints. However, a house has many rooms, so rules
    must express relationships between objects, such as a sprinkler being in a
    certain room. This is best done by using a binding variable as a
    constraint in a pattern. This "join" process results in what is called
    cross products, which are covered in the next section.</p><p>When a fire occurs an instance of the <code class="code">Fire</code> class is
    created, for that room, and inserted into the session. The rule uses a
    binding on the <code class="code">room</code> field of the <code class="code">Fire</code> object to
    constrain matching to the sprinkler for that room, which is currently off.
    When this rule fires and the consequence is executed the sprinkler is
    turned on.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "When there is a fire turn on the sprinkler"
when
    Fire($room : room)
    $sprinkler : Sprinkler( room == $room, on == false )
then
    modify( $sprinkler ) { setOn( true ) };
    System.out.println( "Turn on the sprinkler for room " + $room.getName() );
end</pre><p>Whereas the Stateless Session uses standard Java syntax to modify a
    field, in the above rule we use the <code class="literal">modify</code> statement,
    which acts as a sort of "with" statement. It may contain a series of comma
    separated Java expressions, i.e., calls to setters of the object selected
    by the <code class="literal">modify</code> statement's control expression. This
    modifies the data, and makes the engine aware of those changes so it can
    reason over them once more. This process is called inference, and it's
    essential for the working of a Stateful Session. Stateless Sessions
    typically do not use inference, so the engine does not need to be aware of
    changes to data. Inference can also be turned off explicitly by using the
    <span class="emphasis"><em>sequential mode</em></span>.</p><p>So far we have rules that tell us when matching data exists, but
    what about when it does <span class="emphasis"><em>not</em></span> exist? How do we
    determine that a fire has been extinguished, i.e., that there isn't a
    <code class="code">Fire</code> object any more? Previously the constraints have been
    sentences according to Propositional Logic, where the engine is
    constraining against individual instances. Drools also has support for
    First Order Logic that allows you to look at sets of data. A pattern under
    the keyword <code class="literal">not</code> matches when something does not exist.
    The rule given below turns the sprinkler off as soon as the fire in that
    room has disappeared.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "When the fire is gone turn off the sprinkler"
when
    $room : Room( )
    $sprinkler : Sprinkler( room == $room, on == true )
    not Fire( room == $room )
then
    modify( $sprinkler ) { setOn( false ) };
    System.out.println( "Turn off the sprinkler for room " + $room.getName() );
end</pre><p>While there is one sprinkler per room, there is just a single alarm
    for the building. An <code class="code">Alarm</code> object is created when a fire
    occurs, but only one <code class="code">Alarm</code> is needed for the entire building,
    no matter how many fires occur. Previously <code class="literal">not</code> was
    introduced to match the absence of a fact; now we use its complement
    <code class="literal">exists</code> which matches for one or more instances of some
    category.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Raise the alarm when we have one or more fires"
when
    exists Fire()
then
    insert( new Alarm() );
    System.out.println( "Raise the alarm" );
end</pre><p>Likewise, when there are no fires we want to remove the alarm, so
    the <code class="literal">not</code> keyword can be used again.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Cancel the alarm when all the fires have gone"
when
    not Fire()
    $alarm : Alarm()
then
    retract( $alarm );
    System.out.println( "Cancel the alarm" );
end

</pre><p>Finally there is a general health status message that is printed
    when the application first starts and after the alarm is removed and all
    sprinklers have been turned off.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Status output when things are ok"
when
    not Alarm()
    not Sprinkler( on == true ) 
then
    System.out.println( "Everything is ok" );
end</pre><p>The above rules should be placed in a single DRL file and saved to
    some directory on the classpath and using the file name
    <code class="filename">fireAlarm.drl</code>, as in the Stateless Session example.
    We can then build a Knowledge Base, as before, just using the new name
    <code class="filename">fireAlarm.drl</code>. The difference is that this time we
    create a Stateful Session from the Knowledge Base, whereas before we
    created a Stateless Session.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeBuilder</span><!-- <br/> --><span class="java_plain">&nbsp;kbuilder&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeBuilderFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeBuilder</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">kbuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newClassPathResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;fireAlarm.drl&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;getClass</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DRL&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">hasErrors</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">err</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">getErrors</span><span class="java_separator">().</span><span class="java_plain">toString</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">kbase</span><span class="java_separator">.</span><span class="java_plain">addKnowledgePackages</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">getKnowledgePackages</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">StatefulKnowledgeSession</span><span class="java_plain">&nbsp;ksession&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;kbase</span><span class="java_separator">.</span><span class="java_plain">newStatefulKnowledgeSession</span><span class="java_separator">();</span></pre><p>With the session created it is now possible to iteratively work with
    it over time. Four <code class="code">Room</code> objects are created and inserted, as
    well as one <code class="code">Sprinkler</code> object for each room. At this point the
    engine has done all of its matching, but no rules have fired yet. Calling
    <code class="code">ksession.fireAllRules()</code> allows the matched rules to fire, but
    without a fire that will just produce the health message.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">String</span><!-- <br/> --><span class="java_separator">[]</span><!-- <br/> --><span class="java_plain">&nbsp;names&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">String</span><!-- <br/> --><span class="java_separator">[]{</span><!-- <br/> --><span class="java_literal">&quot;kitchen&quot;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;bedroom&quot;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;office&quot;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;livingroom&quot;</span><!-- <br/> --><span class="java_separator">};</span>
<!--  --><br/><span class="java_type">Map</span><span class="java_operator">&lt;</span><span class="java_type">String</span><span class="java_separator">,</span><span class="java_type">Room</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;name2room&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">HashMap</span><span class="java_operator">&lt;</span><span class="java_type">String</span><span class="java_separator">,</span><span class="java_type">Room</span><span class="java_operator">&gt;</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_keyword">for</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_operator">:</span><span class="java_plain">&nbsp;names&nbsp;</span><span class="java_separator">){</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Room</span><span class="java_plain">&nbsp;room&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Room</span><span class="java_separator">(</span><span class="java_plain">&nbsp;name&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;name2room</span><span class="java_separator">.</span><span class="java_plain">put</span><span class="java_separator">(</span><span class="java_plain">&nbsp;name</span><span class="java_separator">,</span><span class="java_plain">&nbsp;room&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;room&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Sprinkler</span><span class="java_plain">&nbsp;sprinkler&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Sprinkler</span><span class="java_separator">(</span><span class="java_plain">&nbsp;room&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;sprinkler&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">fireAllRules</span><span class="java_separator">();</span>
</pre><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&gt; Everything is ok</pre><p>We now create two fires and insert them; this time a reference is
    kept for the returned <code class="code">FactHandle</code>. A Fact Handle is an
    internal engine reference to the inserted instance and allows instances to
    be retracted or modified at a later point in time. With the fires now in
    the engine, once <code class="code">fireAllRules()</code> is called, the alarm is
    raised and the respective sprinklers are turned on.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Fire</span><!-- <br/> --><span class="java_plain">&nbsp;kitchenFire&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Fire</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;name2room</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">get</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;kitchen&quot;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Fire</span><span class="java_plain">&nbsp;officeFire&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Fire</span><span class="java_separator">(</span><span class="java_plain">&nbsp;name2room</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;office&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_type">FactHandle</span><span class="java_plain">&nbsp;kitchenFireHandle&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kitchenFire&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">FactHandle</span><span class="java_plain">&nbsp;officeFireHandle&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;officeFire&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">fireAllRules</span><span class="java_separator">();</span></pre><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&gt; Raise the alarm
&gt; Turn on the sprinkler for room kitchen
&gt; Turn on the sprinkler for room office</pre><p>After a while the fires will be put out and the <code class="code">Fire</code>
    instances are retracted. This results in the sprinklers being turned off,
    the alarm being cancelled, and eventually the health message is printed
    again.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">ksession</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">retract</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;kitchenFireHandle&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">retract</span><span class="java_separator">(</span><span class="java_plain">&nbsp;officeFireHandle&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">fireAllRules</span><span class="java_separator">();</span></pre><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&gt; Cancel the alarm
&gt; Turn off the sprinkler for room office
&gt; Turn off the sprinkler for room kitchen
&gt; Everything is ok</pre><p>Everyone still with me? That wasn't so hard and already I'm hoping
    you can start to see the value and power of a declarative rule
    system.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e909"/>2.1.3. Methods versus Rules</h3></div></div></div><p>People often confuse methods and rules, and new rule users regular
    ask, "How do I call a rule?" After the last section, you are now feeling
    like a rule expert and the answer to that is obvious, but let's summarize
    the differences nonetheless.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">void</span><!-- <br/> --><span class="java_plain">&nbsp;helloWorld</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">Person</span><!-- <br/> --><span class="java_plain">&nbsp;person</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;person</span><span class="java_separator">.</span><span class="java_plain">getName</span><span class="java_separator">().</span><span class="java_plain">equals</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Chuck&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">out</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Hello&nbsp;Chuck&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre><div class="itemizedlist"><ul><li><p>Methods are called directly.</p></li><li><p>Specific instances are passed.</p></li><li><p>One call results in a single execution.</p></li></ul></div><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Hello World"
    when
        Person( name == "Chuck" )
    then
        System.out.println( "Hello Chuck" );
        end</pre><div class="itemizedlist"><ul><li><p>Rules execute by matching against any data as long it is
        inserted into the engine.</p></li><li><p>Rules can never be called directly.</p></li><li><p>Specific instances cannot be passed to a rule.</p></li><li><p>Depending on the matches, a rule may fire once or several times,
        or not at all.</p></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e941"/>2.1.4. Cross Products</h3></div></div></div><p>Earlier the term "cross product" was mentioned, which is the result
    of a join. Imagine for a moment that the data from the fire alarm example
    were used in combination with the following rule where there ar no field
    constraints:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule
when
    $room : Room()
    $sprinkler : Sprinkler()
then
    System.out.println( "room:" + $room.getName() +
                        " sprinkler:" + $sprinkler.getRoom().getName() );
end</pre><p>In SQL terms this would be like doing <code class="code">select * from Room,
    Sprinkler</code> and every row in the Room table would be joined with
    every row in the Sprinkler table resulting in the following output:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">room:office sprinkler:office
room:office sprinkler:kitchen
room:office sprinkler:livingroom
room:office sprinkler:bedroom
room:kitchen sprinkler:office
room:kitchen sprinkler:kitchen
room:kitchen sprinkler:livingroom
room:kitchen sprinkler:bedroom
room:livingroom sprinkler:office
room:livingroom sprinkler:kitchen
room:livingroom sprinkler:livingroom
room:livingroom sprinkler:bedroom
room:bedroom sprinkler:office
room:bedroom sprinkler:kitchen
room:bedroom sprinkler:livingroom
room:bedroom sprinkler:bedroom</pre><p>These cross products can obviously become huge, and they may very
    well contain spurious data. The size of cross products is often the source
    of performance problems for new rule authors. From this it can be seen
    that it's always desirable to constrain the cross products, which is done
    with the variable constraint.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule
when
    $room : Room()
    $sprinkler : Sprinkler( room == $room )
then
    System.out.println( "room:" + $room.getName() +
                        " sprinkler:" + $sprinkler.getRoom().getName() );
end</pre><p>This results in just four rows of data, with the correct Sprinkler
    for each Room. In SQL (actually HQL) the corresponding query would be
    <code class="code">select * from Room, Sprinkler where Room ==
    Sprinkler.room</code>.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">room:office sprinkler:office
room:kitchen sprinkler:kitchen
room:livingroom sprinkler:livingroom
room:bedroom sprinkler:bedroom</pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e966"/>2.2. Inference</h2></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e969"/>2.2.1. Buss Pass Example</h3></div></div></div><p>Inference has a bad names these days, as something not relevant to
    business use cases and just too complicated to be useful. It is true that
    contrived and complicated examples occur with inference, but that should
    not detract from the fact that simple and useful ones exist too. But more
    than this, correct use of inference can crate more agile and less error
    prone businesses with easier to maintain software.</p><p>So what is inference? Something is inferred when we gain knowledge
    of something from using previous knowledge. For example given a Person
    fact with an age field and a rule that provides age policy control, we can
    infer whether a Person is an adult or a child and act on this.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Infer Adult"
when
  $p : Person( age &gt;= 18 )
then
  insert( new IsAdult( $p ) )
end</pre><p>So in the above every Person who is 18 or over will have an instance
    of IsAdult inserted for them. This fact is special in that it is known as
    a relation. We can use this inferred relation in any rule:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">$p : Person()
IsAdult( person == $p )</pre><p>So now we know what inference is, and have a basic example, how does
    this facilitate good rule design and maintenance?</p><p>Let's take a government department that are responsible for issuing
    ID cards when children become adults, hence forth referred to as ID
    department. They might have a decision table that includes logic like
    this, which says when an adult living in london is 18 or over, issue the
    card:</p><div class="mediaobject"><img src="images/Chapter-Quick_Start/monolithic.png"/></div><p>However the ID department does not set the policy on who an adult
    is. That's done at a central government level. If the central government
    where to change that age to 21 there is a change management process.
    Someone has to liaise with the ID department and make sure their systems
    are updated, in time for the law going live.</p><p>This change management process and communication between departments
    is not ideal for an agile environment and change become costly and error
    prone. Also the card department is managing more information than it needs
    to be aware of with its "monolithic" approach to rules management which is
    "leaking" information better placed else where. By this I mean that it
    doesn't care what explicit "age &gt;= 18" information determines whether
    someone is an adult, only that they are an adult.</p><p>Instead what if we were to split (de-couple) the authoring
    responsibility, so the central government maintains its rules and the ID
    department maintains its.</p><p>So its the central governments job to determine who is an adult and
    if they change the law they just update their central repository with the
    new rules, which others use:</p><div class="mediaobject"><img src="images/Chapter-Quick_Start/InferIsAdult.png"/></div><p>The IsAdult fact, as discussed previously, is inferred from the
    policy rules. It encapsulates the seemingly arbitrary piece of logic "age
    &gt;= 18" and provides semantic abstractions for it's meaning. Now if
    anyone uses the above rules, they no longer need to be aware of explicit
    information that determines whether someone is an adult or not. They can
    just use the inferred fact:</p><div class="mediaobject"><img src="images/Chapter-Quick_Start/IssueIdCard.png"/></div><p>While the example is very minimal and trivial it illustrates some
    important points. We started with a monolithic and leaky approach to our
    knowledge engineering. We create a single decision table that had all
    possible information in it that leaks information from central government
    that the ID department did not care about and did not want to
    manage.</p><p>We first de-coupled the knowledge process so each department was
    responsible for only what it needed to know. We then encapsulated this
    leaky knowledge using an inferred fact IsAdult. The use of the term
    IsAdult also gave a semantic abstraction to the previously arbitrary logic
    "age &gt;= 18".</p><p>So a general rule or thumb when doing your knowledge engineering
    is:</p><div class="itemizedlist"><ul><li><p><span class="bold"><strong>Bad</strong></span></p><div class="itemizedlist"><ul><li><p>Monolithic</p></li><li><p>Leaky</p></li></ul></div></li><li><p><span class="bold"><strong>Good</strong></span></p><div class="itemizedlist"><ul><li><p>De-couple knowledge responsibilities</p></li><li><p>Encapsulate knowledge</p></li><li><p>Provide semantic abstractions for those
            encapsulations</p></li></ul></div></li></ul></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1037"/>2.3. Truth Maintenance with <a id="d0e1040" class="indexterm"/> Logical Objects</h2></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1044"/>2.3.1. Overview</h3></div></div></div><p>After regular inserts you have to retract facts explicitly. With
    <span class="emphasis"><em>logical</em></span> assertions, the fact that was asserted will
    be automatically retracted when the conditions that asserted it in the
    first place are no longer true. Actually, it's even cleverer then that,
    because it will be retracted only if there isn't any single condition that
    supports the logical assertion.</p><p>Normal insertions are said to be <span class="emphasis"><em>stated</em></span>, i.e.,
    just like the intuitive meaning of "stating a fact" implies. Using a
    <code class="code">HashMap</code> and a counter, we track how many times a particular
    equality is <span class="emphasis"><em>stated</em></span>; this means we count how many
    different instances are equal.</p><p>When we <span class="emphasis"><em>logically</em></span> insert an object during a RHS
    execution we are said to <span class="emphasis"><em>justify</em></span> it, and it is
    considered to be justified by the firing rule. For each logical insertion
    there can only be one equal object, and each subsequent equal logical
    insertion increases the justification counter for this logical assertion.
    A justification is removed by the LHS of the creating rule becoming
    untrue, and the counter is decreased accordingly. As soon as we have no
    more justifications the logical object is automatically retracted.</p><p>If we try to <span class="emphasis"><em>logically</em></span> insert an object when
    there is an equal <span class="emphasis"><em>stated</em></span> object, this will fail and
    return null. If we <span class="emphasis"><em>state</em></span> an object that has an
    existing equal object that is <span class="emphasis"><em>justified</em></span> we override
    the Fact; how this override works depends on the configuration setting
    <code class="code">WM_BEHAVIOR_PRESERVE</code>. When the property is set to discard we
    use the existing handle and replace the existing instance with the new
    Object, which is the default behavior; otherwise we override it to
    <span class="emphasis"><em>stated</em></span> but we create an new
    <code class="code">FactHandle</code>.</p><p>This can be confusing on a first read, so hopefully the flow charts
    below help. When it says that it returns a new <code class="code">FactHandle</code>,
    this also indicates the <code class="code">Object</code> was propagated through the
    network.</p><div class="figure"><a id="d0e1102"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Engine/Stated_Assertion.png" align="middle" alt="Stated Insertion"/></div></div><p class="title"><b>Figure 2.1. Stated Insertion</b></p></div><br class="figure-break"/><div class="figure"><a id="d0e1108"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Engine/Logical_Assertion.png" align="middle" alt="Logical Insertion"/></div></div><p class="title"><b>Figure 2.2. Logical Insertion</b></p></div><br class="figure-break"/><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1114"/>2.3.1.1. Bus Pass Example With Inference and TMS</h4></div></div></div><p>The previous example was issuing ID cards to over 18s, in this
      example we now issue bus passes, either a child or adult pass.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Issue Child Bus Pass" when
  $p : Person( age &lt; 16 )
then
  insert(new ChildBusPass( $p ) );
end
 
rule "Issue Adult Bus Pass" when
  $p : Person( age &gt;= 16 )
then
  insert(new AdultBusPass( $p ) );
end</pre><p>As before the above example is considered monolithic, leaky and
      providing poor separation of concerns.</p><p>As before we can provide a more robust application with a
      separation of concerns using inference. Notice this time we don't just
      insert the inferred object, we use "insertLogical":</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Infer Child" when
    $p : Person( age &lt; 16 )
then
    insertLogical( new IsChild( $p ) )
end
rule "Infer Adult" when
    $p : Person( age &gt;= 16 )
then
    insertLogical( new IsAdult( $p ) )
end</pre><p>A "insertLogical" is part of the Drools Truth Maintenance System
      (TMS). Here the fact is logically inserted, this fact is dependant on
      the truth of the "when" clause. It means that when the rule becomes
      false the fact is automatically retracted. This works particularly well
      as the two rules are mutually exclusive. So in the above rules if the
      person is under 16 it inserts an IsChild fact, once the person is 16 or
      over the IsChild fact is automatically retracted and the IsAdult fact
      inserted.</p><p>We can now bring back in the code to issue the passes, these two
      can also be logically inserted, as the TMS supports chaining of logical
      insertions for a cascading set of retracts.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Issue Child Bus Pass" when
  $p : Person( )
       IsChild( person == $p )
then
    insertLogical(new ChildBusPass( $p ) );
end
 
rule "Issue Adult Bus Pass" when
  $p : Person( age &gt;= 16 )
       IsAdult( person =$p )
then
    insertLogical(new AdultBusPass( $p ) );
end</pre><p>Now when the person changes from being 15 to 16, not only is the
      IsChild fact automatically retracted, so is the person's ChildBusPass
      fact. For bonus points we can combine this with the 'not' conditional
      element to handle notifications, in this situation a request for the
      returning of the pass. So when the TMS automatically retracts the
      ChildBusPass object, this rule triggers and sends a request to the
      person:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Return ChildBusPass Request "when
  $p : Person( )
       not( ChildBusPass( person == $p ) )
then
    requestChildBusPass( $p );
end</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1137"/>2.3.1.2. Lazy Truth Maintenance</h4></div></div></div><p>You no longer need to enable or disable truth maintenance, via the
      kbase configuration. It is now handled automatically and turned on only
      when needed. This was done along with the code changes so that all entry
      points use the same code, previous to this the default entry point and
      named entry points used different code, to avoid TMS overhead for event
      processing.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1142"/>2.3.1.3. Important note: Equality for Java objects</h4></div></div></div><p>It is important to note that for Truth Maintenance (and logical
      assertions) to work at all, your Fact objects (which may be JavaBeans)
      must override equals and hashCode methods (from java.lang.Object)
      correctly. As the truth maintenance system needs to know when two
      different physical objects are equal in value, <span class="emphasis"><em>both</em></span>
      equals and hashCode must be overridden correctly, as per the Java
      standard.</p><p>Two objects are equal if and only if their equals methods return
      true for each other and if their hashCode methods return the same
      values. See the Java API for more details (but do keep in mind you
      <span class="emphasis"><em>MUST</em></span> override both equals and hashCode).</p><p>TMS behaviour is not affected by theruntime configuration of
      Identity vs Equality, TMS is always equality.</p></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1157"/>2.4. Decision Tables in Spreadsheets</h2></div></div></div><p>Decision tables are a "precise yet compact" (ref. Wikipedia) way of representing conditional logic, and are well
  suited to <span class="emphasis"><em>business</em></span> level rules.</p><p>Drools supports managing rules in a spreadsheet format. Supported formats are Excel (XLS), and CSV, which means
  that a variety of spreadsheet programs (such as Microsoft Excel, OpenOffice.org Calc amongst others) can be utilized.
  It is expected that web based decision table editors will be included in a near future release.</p><p>Decision tables are an old concept (in software terms) but have proven useful over the years. Very briefly
  speaking, in Drools decision tables are a way to generate rules driven from the data entered into a spreadsheet. All
  the usual features of a spreadsheet for data capture and manipulation can be taken advantage of.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1169"/>2.4.1. When to Use Decision Tables</h3></div></div></div><p>Consider decision tables as a course of action if rules exist that can be expressed as rule templates and
    data: each row of a decision table provides data that is combined with a template to generate a rule.</p><p>Many businesses already use spreadsheets for managing data, calculations, etc. If you are happy to continue
    this way, you can also manage your business rules this way. This also assumes you are happy to manage packages of
    rules in <code class="filename">.xls</code> or <code class="filename">.csv</code> files. Decision tables are not recommended for rules
    that do not follow a set of templates, or where there are a small number of rules (or if there is a dislike towards
    software like Excel or OpenOffice.org). They are ideal in the sense that there can be control over what
    <span class="emphasis"><em>parameters</em></span> of rules can be edited, without exposing the rules directly.</p><p>Decision tables also provide a degree of insulation from the underlying object model.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1187"/>2.4.2. Overview</h3></div></div></div><p>Here are some examples of real world decision tables (slightly edited to protect the innocent).</p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/excel.png"/></div></div><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/actions.png"/></div></div><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/open_office.png"/></div></div><p>In the above examples, the technical aspects of the decision table have been collapsed away (using a standard
    spreadsheet feature).</p><p>The rules start from row 17, with each row resulting in a rule. The conditions are in columns C, D, E, etc.,
    the actions being off-screen. The values in the cells are quite simple, and their meaning is indicated by the
    headers in Row 16. Column B is just a description. It is customary to use color to make it obvious what the
    different areas of the table mean.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Note that although the decision tables look like they process top down, this is not necessarily the case.
      Ideally, rules are authored without regard for the order of rows, simply because this makes maintenance easier, as
      rows will not need to be shifted around all the time.</p></div><p>As each row is a rule, the same principles apply. As the rule engine processes the facts, any rules that match
    may fire. (Some people are confused by this. It is possible to clear the agenda when a rule fires and simulate a
    very simple decision table where only the first match effects an action.) Also note that you can have multiple
    tables on one spreadsheet. This way, rules can be grouped where they share common templates, yet at the end of the
    day they are all combined into one rule package. Decision tables are essentially a tool to generate DRL rules
    automatically.</p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/multi_table.png"/></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1225"/>2.4.3. How Decision Tables Work</h3></div></div></div><p>The key point to keep in mind is that in a decision table each row is a rule, and each column in that row is
    either a condition or action for that rule.</p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/row_col.png"/></div></div><p>The spreadsheet looks for the <em class="firstterm">RuleTable</em> keyword to indicate the start of a rule table
    (both the starting row and column). Other keywords are also used to define other package level attributes (covered
    later). It is important to keep the keywords in one column. By convention the second column ("B") is used for this,
    but it can be any column (convention is to leave a margin on the left for notes). In the following diagram, C is
    actually the column where it starts. Everything to the left of this is ignored.</p><p>If we expand the hidden sections, it starts to make more sense how it works; note the keywords in column
    C.</p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/expanded.png"/></div></div><p>Now the hidden magic which makes it work can be seen. The RuleSet keyword indicates the name to be used in the
    <span class="emphasis"><em>rule package</em></span> that will encompass all the rules. This name is optional, using a default, but it
    <span class="emphasis"><em>must</em></span> have the <span class="emphasis"><em>RuleSet</em></span> keyword in the cell immediately to the right.</p><p>The other keywords visible in Column C are Import and Sequential which will be covered later. The RuleTable
    keyword is important as it indicates that a chunk of rules will follow, based on some rule templates. After the
    RuleTable keyword there is a name, used to prefix the names of the generated rules. The sheet name and row numbers
    are appended to guarantee unique rule names.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>The RuleTable name combined with the sheet name must be unique across all spreadsheet files in the same
      KnowledgeBase. If that's not the case, some rules might have the same name and only 1 of them will be applied.
      To show such ignored rules, <a class="link" href="ch03.html#changingTheDefaultBuildResultSeverity" title="3.1.3. Changing the Default Build Result Severity">raise the severity of such rule
      name conflicts</a>.</p></div><p> The column of RuleTable indicates the column in which the rules start; columns to the
    left are ignored.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>In general the keywords make up name-value pairs.</p></div><p>Referring to row 14 (the row immediately after RuleTable), the keywords CONDITION and ACTION indicate that the
    data in the columns below are for either the LHS or the RHS parts of a rule. There are other attributes on the rule
    which can also be optionally set this way.</p><p>Row 15 contains declarations of <em class="firstterm">ObjectTypes</em>. The content in this row is optional, but
    if this option is not in use, the row must be left blank; however this option is usually found to be quite useful.
    When using this row, the values in the cells below (row 16) become constraints on that object type. In the above
    case, it generates <code class="code">Person(age=="42")</code> and <code class="code">Cheese(type=="stilton")</code>, where 42 and "stilton"
    come from row 18. In the above example, the "==" is implicit; if just a field name is given the translator assumes
    that it is to generate an exact match.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>An ObjectType declaration can span columns (via merged cells), meaning that all columns below the merged
      range are to be combined into one set of constraints within a single pattern matching a single fact at a time, as
      opposed to non-merged cells containing the same ObjectType, but resulting in different patterns, potentially
      matching different or identical facts.</p></div><p>Row 16 contains the rule templates themselves. They can use the "$param" placeholder to indicate where data
    from the cells below should be interpolated. (For multiple insertions, use "$1", "$2", etc., indicating parameters
    from a comma-separated list in a cell below.) Row 17 is ignored; it may contain textual descriptions of the column's
    purpose.</p><p>Rows 18 and 19 show data, which will be combined (interpolated) with the templates in row 15, to generate
    rules. If a cell contains no data, then its template is ignored. (This would mean that some condition or action does
    not apply for that rule row.) Rule rows are read until there is a blank row. Multiple RuleTables can exist in a
    sheet. Row 20 contains another keyword, and a value. The row positions of keywords like this do not matter (most
    people put them at the top) but their column should be the same one where the RuleTable or RuleSet keywords should
    appear. In our case column C has been chosen to be significant, but any other column could be used instead.</p><p>In the above example, rules would be rendered like the following (as it uses the "ObjectType" row):</p><pre class="screen">//row 18
rule "Cheese_fans_18"
when
    Person(age=="42")
    Cheese(type=="stilton")
then
    list.add("Old man stilton");
end
</pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>The constraints <code class="code">age=="42"</code> and <code class="code">type=="stilton"</code> are interpreted as single
      constraints, to be added to the respective ObjectType in the cell above. If the cells above were spanned, then
      there could be multiple constraints on one "column".</p></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>Very large decision tables may have very large memory requirements.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1309"/>2.4.4. Spreadsheet Syntax</h3></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1312"/>2.4.4.1. Spreadsheet Structure</h4></div></div></div><p>There are two types of rectangular areas defining data that is used for generating a DRL file. One, marked
      by a cell labelled <code class="code">RuleSet</code>, defines all DRL items except rules. The other one may occur repeatedly
      and is to the right and below a cell whose contents begin with <code class="code">RuleTable</code>. These areas represent the
      actual decision tables, each area resulting in a set of rules of similar structure.</p><p>A Rule Set area may contain cell pairs, one below the <code class="code">RuleSet</code> cell and containing a keyword
      designating the kind of value contained in the other one that follows in the same row.</p><p>The columns of a Rule Table area define patterns and constraints for the left hand sides of the rules
      derived from it, actions for the consequences of the rules, and the values of individual rule attributes. Thus, a
      Rule Table area should contain one or more columns, both for conditions and actions, and an arbitrary selection of
      columns for rule attributes, at most one column for each of these. The first four rows following the row with the
      cell marked with <code class="code">RuleTable</code> are earmarked as header area, mostly used for the definition of code to
      construct the rules. It is any additional row below these four header rows that spawns another rule, with its data
      providing for variations in the code defined in the Rule Table header.</p><p>All keywords are case insensitive.</p><p>Only the first worksheet is examined for decision tables.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1337"/>2.4.4.2. Rule Set Entries</h4></div></div></div><p>Entries in a Rule Set area may define DRL constructs (except rules), and specify rule attributes. While
      entries for constructs may be used repeatedly, each rule attribute may be given at most once, and it applies to
      all rules unless it is overruled by the same attribute being defined within the Rule Table area.</p><p>Entries must be given in a vertically stacked sequence of cell pairs. The first one contains a keyword and
      the one to its right the value, as shown in the table below. This sequence of cell pairs may be interrupted by
      blank rows or even a Rule Table, as long as the column marked by <code class="code">RuleSet</code> is upheld as the one
      containing the keyword.</p><div class="table"><a id="d0e1347"/><p class="title"><b>Table 2.1. Entries in the Rule Set area</b></p><div class="table-contents"><table summary="Entries in the Rule Set area" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Keyword</th><th>Value</th><th>Usage</th></tr></thead><tbody><tr><td>RuleSet</td><td>The package name for the generated DRL file. Optional, the default is
              <code class="code">rule_table</code>.</td><td>Must be First entry.</td></tr><tr><td>Sequential</td><td>"true" or "false". If "true", then salience is used to ensure that rules fire from the top
              down.</td><td>Optional, at most once. If omitted, no firing order is imposed.</td></tr><tr><td>EscapeQuotes</td><td>"true" or "false". If "true", then quotation marks are escaped so that they appear literally in the
              DRL.</td><td>Optional, at most once. If omitted, quotation marks are escaped.</td></tr><tr><td>Import</td><td>A comma-separated list of Java classes to import.</td><td>Optional, may be used repeatedly.</td></tr><tr><td>Variables</td><td>Declarations of DRL globals, i.e., a type followed by a variable name. Multiple global definitions
              must be separated with a comma.</td><td>Optional, may be used repeatedly.</td></tr><tr><td>Functions</td><td>One or more function definitions, according to DRL syntax.</td><td>Optional, may be used repeatedly.</td></tr><tr><td>Queries</td><td>One or more query definitions, according to DRL syntax.</td><td>Optional, may be used repeatedly.</td></tr><tr><td>Declare</td><td>One or more declarative types, according to DRL syntax.</td><td>Optional, may be used repeatedly.</td></tr></tbody></table></div></div><br class="table-break"/><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>In some locales, MS Office, LibreOffice and OpenOffice will encode a double quoth <code class="literal">"</code>
        differently, which will cause a compilation error. The difference is often hard to see. For example:
        <code class="literal">“A”</code> will fail, but <code class="literal">"A"</code> will work.</p></div><p>For defining rule attributes that apply to all rules in the generated DRL file you can use any of the
      entries in the following table. Notice, however, that the proper keyword must be used. Also, each of these
      attributes may be used only once.</p><div class="table"><a id="d0e1433"/><p class="title"><b>Table 2.2. Rule attribute entries in the Rule Set area</b></p><div class="table-contents"><table summary="Rule attribute entries in the Rule Set area" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Keyword</th><th>Initial</th><th>Value</th></tr></thead><tbody><tr><td>PRIORITY</td><td>P</td><td>An integer defining the "salience" value for the rule. Overridden by the "Sequential" flag.</td></tr><tr><td>DURATION</td><td>D</td><td>A long integer value defining the "duration" value for the rule.</td></tr><tr><td>TIMER</td><td>T</td><td>A timer definition. See "Timers and Calendars".</td></tr><tr><td>CALENDARS</td><td>E</td><td>A calendars definition. See "Timers and Calendars".</td></tr><tr><td>NO-LOOP</td><td>U</td><td>A Boolean value. "true" inhibits looping of rules due to changes made by its consequence.</td></tr><tr><td>LOCK-ON-ACTIVE</td><td>L</td><td>A Boolean value. "true" inhibits additional activations of all rules with this flag set within the
              same ruleflow or agenda group.</td></tr><tr><td>AUTO-FOCUS</td><td>F</td><td>A Boolean value. "true" for a rule within an agenda group causes activations of the rule to
              automatically give the focus to the group.</td></tr><tr><td>ACTIVATION-GROUP</td><td>X</td><td>A string identifying an activation (or XOR) group. Only one rule within an activation group will
              fire, i.e., the first one to fire cancels any existing activations of other rules within the same
              group.</td></tr><tr><td>AGENDA-GROUP</td><td>G</td><td>A string identifying an agenda group, which has to be activated by giving it the "focus", which is
              one way of controlling the flow between groups of rules.</td></tr><tr><td>RULEFLOW-GROUP</td><td>R</td><td>A string identifying a rule-flow group.</td></tr></tbody></table></div></div><br class="table-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1516"/>2.4.4.3. Rule Tables</h4></div></div></div><p>All Rule Tables begin with a cell containing "RuleTable", optionally followed by a string within the same
      cell. The string is used as the initial part of the name for all rules derived from this Rule Table, with the row
      number appended for distinction. (This automatic naming can be overridden by using a NAME column.) All other cells
      defining rules of this Rule Table are below and to the right of this cell.</p><p>The next row defines the column type, with each column resulting in a part of the condition or the
      consequence, or providing some rule attribute, the rule name or a comment. The table below shows which column
      headers are available; additional columns may be used according to the table showing rule attribute entries given
      in the preceding section. Note that each attribute column may be used at most once. For a column header, either
      use the keyword or any other word beginning with the letter given in the "Initial" column of these tables.</p><div class="table"><a id="d0e1523"/><p class="title"><b>Table 2.3. Column Headers in the Rule Table</b></p><div class="table-contents"><table summary="Column Headers in the Rule Table" border="1"><colgroup><col/><col/><col/><col/></colgroup><thead><tr><th>Keyword</th><th>Initial</th><th>Value</th><th>Usage</th></tr></thead><tbody><tr><td>NAME</td><td>N</td><td>Provides the name for the rule generated from that row. The default is constructed from the text
              following the RuleTable tag and the row number.</td><td>At most one column</td></tr><tr><td>DESCRIPTION</td><td>I</td><td>A text, resulting in a comment within the generated rule.</td><td>At most one column</td></tr><tr><td>CONDITION</td><td>C</td><td>Code snippet and interpolated values for constructing a constraint within a pattern in a
              condition.</td><td>At least one per rule table</td></tr><tr><td>ACTION</td><td>A</td><td>Code snippet and interpolated values for constructing an action for the consequence of the
              rule.</td><td>At least one per rule table</td></tr><tr><td>METADATA</td><td>@</td><td>Code snippet and interpolated values for constructing a metadata entry for the rule.</td><td>Optional, any number of columns</td></tr></tbody></table></div></div><br class="table-break"/><p>Given a column headed CONDITION, the cells in successive lines result in a conditional element.</p><div class="itemizedlist"><ul><li><p>Text in the first cell below CONDITION develops into a pattern for the rule condition, with the snippet
          in the next line becoming a constraint. If the cell is merged with one or more neighbours, a single pattern
          with multiple constraints is formed: all constraints are combined into a parenthesized list and appended to
          the text in this cell. The cell may be left blank, which means that the code snippet in the next row must
          result in a valid conditional element on its own.</p><p>To include a pattern without constraints, you can write the pattern in front of the text for another
          pattern.</p><p>The pattern may be written with or without an empty pair of parentheses. A "from" clause may be appended
          to the pattern.</p><p>If the pattern ends with "eval", code snippets are supposed to produce boolean expressions for inclusion
          into a pair of parentheses after "eval".</p></li><li><p>Text in the second cell below CONDITION is processed in two steps.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>The code snippet in this cell is modified by interpolating values from cells farther down in the
              column. If you want to create a constraint consisting of a comparison using "==" with the value from the
              cells below, the field selector alone is sufficient. Any other comparison operator must be specified as
              the last item within the snippet, and the value from the cells below is appended. For all other constraint
              forms, you must mark the position for including the contents of a cell with the symbol
              <code class="code">$param</code>. Multiple insertions are possible by using the symbols <code class="code">$1</code>,
              <code class="code">$2</code>, etc., and a comma-separated list of values in the cells below.</p><p>A text according to the pattern
              <code class="code">forall(</code><span class="emphasis"><em>delimiter</em></span><code class="code">){</code><span class="emphasis"><em>snippet</em></span><code class="code">}</code>
              is expanded by repeating the <span class="emphasis"><em>snippet</em></span> once for each of the values of the
              comma-separated list of values in each of the cells below, inserting the value in place of the symbol
              <code class="code">$</code> and by joining these expansions by the given <span class="emphasis"><em>delimiter</em></span>. Note that the
              forall construct may be surrounded by other text.</p></li><li><p>If the cell in the preceding row is not empty, the completed code snippet is added to the
              conditional element from that cell. A pair of parentheses is provided automatically, as well as a
              separating comma if multiple constraints are added to a pattern in a merged cell.</p><p>If the cell above is empty, the interpolated result is used as is.</p></li></ol></div></li><li><p>Text in the third cell below CONDITION is for documentation only. It should be used to indicate the
          column's purpose to a human reader.</p></li><li><p>From the fourth row on, non-blank entries provide data for interpolation as described above. A blank
          cell results in the omission of the conditional element or constraint for this rule.</p></li></ul></div><p>Given a column headed ACTION, the cells in successive lines result in an action statement.</p><div class="itemizedlist"><ul><li><p>Text in the first cell below ACTION is optional. If present, it is interpreted as an object
          reference.</p></li><li><p>Text in the second cell below ACTION is processed in two steps.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>The code snippet in this cell is modified by interpolating values from cells farther down in the
              column. For a singular insertion, mark the position for including the contents of a cell with the symbol
              <code class="code">$param</code>. Multiple insertions are possible by using the symbols <code class="code">$1</code>,
              <code class="code">$2</code>, etc., and a comma-separated list of values in the cells below.</p><p>A method call without interpolation can be achieved by a text without any marker symbols. In this
              case, use any non-blank entry in a row below to include the statement.</p><p>The forall construct is available here, too.</p></li><li><p>If the first cell is not empty, its text, followed by a period, the text in the second cell and a
              terminating semicolon are stringed together, resulting in a method call which is added as an action
              statement for the consequence.</p><p>If the cell above is empty, the interpolated result is used as is.</p></li></ol></div></li><li><p>Text in the third cell below ACTION is for documentation only. It should be used to indicate the
          column's purpose to a human reader.</p></li><li><p>From the fourth row on, non-blank entries provide data for interpolation as described above. A blank
          cell results in the omission of the action statement for this rule.</p></li></ul></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Using <code class="code">$1</code> instead of <code class="code">$param</code> works in most cases, but it will fail if the
        replacement text contains a comma: then, only the part preceding the first comma is inserted. Use this
        "abbreviation" judiciously.</p></div><p>Given a column headed METADATA, the cells in successive lines result in a metadata annotation for the
      generated rules.</p><div class="itemizedlist"><ul><li><p>Text in the first cell below METADATA is ignored.</p></li><li><p>Text in the second cell below METADATA is subject to interpolation, as described above, using values
          from the cells in the rule rows. The metadata marker character <code class="code">@</code> is prefixed automatically, and
          thus it should not be included in the text for this cell.</p></li><li><p>Text in the third cell below METADATA is for documentation only. It should be used to indicate the
          column's purpose to a human reader.</p></li><li><p>From the fourth row on, non-blank entries provide data for interpolation as described above. A blank
          cell results in the omission of the metadata annotation for this rule.</p></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1708"/>2.4.4.4. Examples</h4></div></div></div><p>The various interpolations are illustrated in the following example.</p><div class="example"><a id="d0e1713"/><p class="title"><b>Example 2.1. Interpolating cell data</b></p><div class="example-contents"><p>If the template is <code class="code">Foo(bar == $param)</code> and the cell is <code class="code">42</code>, then the result is
        <code class="code">Foo(bar == 42)</code>.</p><p>If the template is <code class="code">Foo(bar &lt; $1, baz == $2)</code> and the cell contains <code class="code">42,43</code>, the
        result will be <code class="code">Foo(bar &lt; 42, baz ==43)</code>.</p><p>The template <code class="code">forall(&amp;&amp;){bar != $}</code> with a cell containing <code class="code">42,43</code> results
        in <code class="code">bar != 42 &amp;&amp; bar != 43</code>.</p></div></div><br class="example-break"/><p>The next example demonstrates the joint effect of a cell defining the pattern type and the code snippet
      below it. </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/spanned_column.png"/></div></div><p> This spreadsheet section shows how the <code class="code">Person</code> type declaration spans 2 columns, and
      thus both constraints will appear as <code class="code">Person(age == ..., type == ...)</code>. Since only the field names are
      present in the snippet, they imply an equality test.</p><p>In the following example the marker symbol <code class="code">$param</code> is used. </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/with_param.png"/></div></div><p> The result of this column is the pattern <code class="code">Person(age == "42"))</code>. You may have noticed
      that the marker and the operator "==" are redundant.</p><p>The next example illustrates that a trailing insertion marker can be omitted. </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/operator_completion.png"/></div></div><p> Here, appending the value from the cell is implied, resulting in <code class="code">Person(age &lt;
      "42")).</code></p><p>You can provide the definition of a binding variable, as in the example below. . </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/with_binding.png"/></div></div><p> Here, the result is <code class="code">c: Cheese(type == "stilton").</code> Note that the quotes are provided
      automatically. Actually, anything can be placed in the object type row. Apart from the definition of a binding
      variable, it could also be an additional pattern that is to be inserted literally.</p><p>A simple construction of an action statement with the insertion of a single value is shown below.
      </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/consequence.png"/></div></div><p> The cell below the ACTION header is left blank. Using this style, anything can be placed in the
      consequence, not just a single method call. (The same technique is applicable within a CONDITION column as
      well.)</p><p>Below is a comprehensive example, showing the use of various column headers. It is not an error to have no
      value below a column header (as in the NO-LOOP column): here, the attribute will not be applied in any of the
      rules. </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/Key.png"/></div></div><p>And, finally, here is an example of Import, Variables and Functions. </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/keywords.png"/></div></div><p> Multiple package names within the same cell must be separated by a comma. Also, the pairs of type
      and variable names must be comma-separated. Functions, however, must be written as they appear in a DRL file. This
      should appear in the same column as the "RuleSet" keyword; it could be above, between or below all the rule
      rows.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>It may be more convenient to use Import, Variables, Functions and Queries repeatedly rather than packing
        several definitions into a single cell.</p></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1821"/>2.4.5. Creating and integrating Spreadsheet based Decision Tables</h3></div></div></div><p>The API to use spreadsheet based decision tables is in the drools-decisiontables module. There is really only
    one class to look at: <code class="literal">SpreadsheetCompiler</code>. This class will take spreadsheets in various formats,
    and generate rules in DRL (which you can then use in the normal way). The <code class="literal">SpreadsheetCompiler</code> can
    just be used to generate partial rule files if it is wished, and assemble it into a complete rule package after the
    fact (this allows the separation of technical and non-technical aspects of the rules if needed).</p><p>To get started, a sample spreadsheet can be used as a base. Alternatively, if the plug-in is being used (Rule
    Workbench IDE), the wizard can generate a spreadsheet from a template (to edit it an xls compatible spreadsheet
    editor will need to be used). </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/wizard.png"/></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1840"/>2.4.6. Managing Business Rules in Decision Tables</h3></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1843"/>2.4.6.1. Workflow and Collaboration</h4></div></div></div><p>Spreadsheets are well established business tools (in use for over 25 years). Decision tables lend themselves
      to close collaboration between IT and domain experts, while making the business rules clear to business analysts,
      it is an ideal separation of concerns.</p><p>Typically, the whole process of authoring rules (coming up with a new decision table) would be something
      like:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>Business analyst takes a template decision table (from a repository, or from IT)</p></li><li><p>Decision table business language descriptions are entered in the table(s)</p></li><li><p>Decision table rules (rows) are entered (roughly)</p></li><li><p>Decision table is handed to a technical resource, who maps the business language (descriptions) to
          scripts (this may involve software development of course, if it is a new application or data model)</p></li><li><p>Technical person hands back and reviews the modifications with the business analyst.</p></li><li><p>The business analyst can continue editing the rule rows as needed (moving columns around is also fine
          etc).</p></li><li><p>In parallel, the technical person can develop test cases for the rules (liaising with business analysts)
          as these test cases can be used to verify rules and rule changes once the system is running.</p></li></ol></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1872"/>2.4.6.2. Using spreadsheet features</h4></div></div></div><p>Features of applications like Excel can be used to provide assistance in entering data into spreadsheets,
      such as validating fields. Lists that are stored in other worksheets can be used to provide valid lists of values
      for cells, like in the following diagram. </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/lists.png"/></div></div><p>Some applications provide a limited ability to keep a history of changes, but it is recommended to use an
      alternative means of revision control. When changes are being made to rules over time, older versions are archived
      (many open source solutions exist for this, such as Subversion or Git).</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1885"/>2.4.7. Rule Templates</h3></div></div></div><p>Related to decision tables (but not necessarily requiring a spreadsheet) are "Rule Templates" (in the
    drools-templates module). These use any tabular data source as a source of rule data - populating a template to
    generate many rules. This can allow both for more flexible spreadsheets, but also rules in existing databases for
    instance (at the cost of developing the template up front to generate the rules).</p><p>With Rule Templates the data is separated from the rule and there are no restrictions on which part of the
    rule is data-driven. So whilst you can do everything you could do in decision tables you can also do the
    following:</p><div class="itemizedlist"><ul><li><p>store your data in a database (or any other format)</p></li><li><p>conditionally generate rules based on the values in the data</p></li><li><p>use data for any part of your rules (e.g. condition operator, class name, property name)</p></li><li><p>run different templates over the same data</p></li></ul></div><p>As an example, a more classic decision table is shown, but without any hidden rows for the rule meta data (so
    the spreadsheet only contains the raw data to generate the rules).</p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/template1.png"/></div></div><p>See the <code class="filename">ExampleCheese.xls</code> in the examples download for the above spreadsheet.</p><p>If this was a regular decision table there would be hidden rows before row 1 and between rows 1 and 2
    containing rule metadata. With rule templates the data is completely separate from the rules. This has two handy
    consequences - you can apply multiple rule templates to the same data and your data is not tied to your rules at
    all. So what does the template look like?</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
1  template header
2  age
3  type
4  log
5
6  package org.drools.examples.templates;
7
8  global java.util.List list;
9
10 template "cheesefans"
11
12 rule "Cheese fans_@{row.rowNumber}"
13 when
14    Person(age == @{age})
15    Cheese(type == "@{type}")
16 then
17    list.add("@{log}");
18 end
19
20 end template
</pre><p>Annotations to the preceding program listing: </p><div class="itemizedlist"><ul><li><p>Line 1: All rule templates start with <code class="code">template header</code>.</p></li><li><p>Lines 2-4: Following the header is the list of columns in the order they appear in the data. In this
          case we are calling the first column <code class="code">age</code>, the second <code class="code">type</code> and the third
          <code class="code">log</code>.</p></li><li><p>Line 5: An empty line signifies the end of the column definitions.</p></li><li><p>Lines 6-9: Standard rule header text. This is standard rule DRL and will appear at the top of the
          generated DRL. Put the package statement and any imports and global and function definitions into this
          section.</p></li><li><p>Line 10: The keyword <code class="code">template</code> signals the start of a rule template. There can be more than
          one template in a template file, but each template should have a unique name.</p></li><li><p>Lines 11-18: The rule template - see below for details.</p></li><li><p>Line 20: The keywords <code class="code">end template</code> signify the end of the template.</p></li></ul></div><p>The rule templates rely on MVEL to do substitution using the syntax @{token_name}. There is currently one
    built-in expression, @{row.rowNumber} which gives a unique number for each row of data and enables you to generate
    unique rule names. For each row of data a rule will be generated with the values in the data substituted for the
    tokens in the template. With the example data above the following rule file would be generated:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
package org.drools.examples.templates;

global java.util.List list;

rule "Cheese fans_1"
when
  Person(age == 42)
  Cheese(type == "stilton")
then
  list.add("Old man stilton");
end

rule "Cheese fans_2"
when
  Person(age == 21)
  Cheese(type == "cheddar")
then
  list.add("Young man cheddar");
end
</pre><p>The code to run this is simple:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_type">DecisionTableConfiguration</span><span class="java_plain">&nbsp;dtableconfiguration&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeBuilderFactory</span><span class="java_separator">.</span><span class="java_plain">newDecisionTableConfiguration</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">dtableconfiguration</span><span class="java_separator">.</span><span class="java_plain">setInputType</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">DecisionTableInputType</span><span class="java_separator">.</span><span class="java_plain">XLS&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_type">KnowledgeBuilder</span><span class="java_plain">&nbsp;kbuilder&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBuilderFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBuilder</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">kbuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newClassPathResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;getSpreadsheetName</span><span class="java_separator">(),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getClass</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DTABLE</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dtableconfiguration&nbsp;</span><span class="java_separator">);</span>
</pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1972"/>2.5. Templates</h2></div></div></div><p>If you discover that you have a group of rules following
    the same arrangement of patterns, constraints and actions on
    the RHS, differing only in constants or names for objects or
    fields, you might think of employing Drools's rule template feature
    for generating the actual rules. You would write a 
    <span class="emphasis"><em>rule template</em></span> file, containing the
    textual skeleton of your rule and use the Drools template
    compiler in combination with a collection of objects providing
    the actual values for the "flesh" of the rules for their
    instantiation.</p><p>The mechanism is very similar to what a macro processor
    does. The major advantage proffered by template expansion is
    that it's nicely integrated in the overall handling of
    Knowledge Resources.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="caution"><h2>Caution</h2><p>This is an experimental feature. In particular,
    the API is subject to change.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1985"/>2.5.1. The Rule Template File</h3></div></div></div><p>A rule template file begins with a header defining the
      placeholders, or <span class="emphasis"><em>formal template parameters</em></span> 
      for the strings that are to be inserted during instantiation. 
      After the first line, which invariably contains <code class="literal">template header</code>,
      you should write a number of lines, each of which contains a single
      parameter name.</p><div class="example"><a id="d0e1996"/><p class="title"><b>Example 2.2. Rule template file: template header</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>template header</strong></span>
<span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>parameter-name-1</em></span>
...
<span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>parameter-name-n</em></span>
...</pre></div></div><br class="example-break"/><p>The template header is followed by the text that is to
      be replicated and interpolated with the actual parameters. It
      may begin with a <code class="literal">package</code> statement, followed by some
      additional lines. These 
      may be sectioned into one or more templates, each of them
      between a pair of matching <code class="literal">template</code> and
      <code class="literal">end template</code> statements. The <code class="literal">template</code> takes
      an argument, which puts a name to the template. The name
      can be a simple unquoted name or an arbitrary string enclosed
      in double quotes. The template text between these lines may
      contain one or more rules, constituting the "raw material"
      for the expansion.</p><div class="example"><a id="d0e2024"/><p class="title"><b>Example 2.3. Rule template file: templates</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>template header</strong></span>
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong><span class="emphasis"><em>parameter-name-1</em></span></strong></span>
...
<span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>parameter-name-n</em></span>
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>package ...</strong></span>     // optional
<span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>header text</em></span>    // optional
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>template</strong></span> <span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>template-name</em></span>
...
// template text
...
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>end template</strong></span>
...</pre></div></div><br class="example-break"/><p>The resulting text will begin with the package line and the
      header text following it, if present. Then, each template text
      will be expanded individually, yielding one set of rules for each
      of the actual parameter sets. Therefore, the structure of the
      template sections affect the order of the generated rules, since
      the generator iterates over the sections and then over the
      set of actual parameters.</p><p>Any interpolation takes place between a pair of <code class="literal">template</code>
      and <code class="literal">end template</code> statements, when this template is
      expanded. The template text is scanned for occurrences of
      <span class="emphasis"><em>parameter expansions</em></span> written according to:
      </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>@{<span class="emphasis"><em>parameter-name</em></span>}</strong></span></pre><p>
      The name between '@{' and '}' should be one of the parameter names
      defined in the template header. The substitution is effected anywhere,
      even within string literals.</p><p>An important parameter is available without having to be
      included in the data source providing the actual values. The
      parameter substitution
      <span class="bold"><strong><code class="code">@{row.rowNumber}</code></strong></span>
      expands to the integers 0, 1, 2, etc., providing a unique distinction
      for the instantiation derived from a parameter set. You would use this
      as part of each rule name, because, without this precaution, there
      would be duplicate rule names. (You are, of course, free to use your
      own identification included as an extra parameter.)</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e2081"/>2.5.2. Expanding a Template</h3></div></div></div><p>To expand a template, you must prepare a data source. This can
      be a spreadsheet, as explained in the previous section. Here, we'll
      concentrate on expansion driven by Java objects. There are two
      straightforward ways of supplying values for a fixed set of names:
      Java objects, in the JavaBeans style, and Maps. Both of them can
      be arranged in a <code class="code">Collection</code>, whose elements will be
      processed during the expansion, resulting in an instantiation
      for each element.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e2089"/>2.5.2.1. Instantiation from Java Objects</h4></div></div></div><p>You may use a Java object that provides getter methods
        corresponding to all of the parameter names of your template
        file. If, for instance, you have defined a header</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
template header
type
limit
word</pre><p>the following Java class could be used:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">ParamSet</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">ParamSet</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;t</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;l</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;w&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;&nbsp;getType</span><span class="java_separator">(){...}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getLimit</span><span class="java_separator">(){...}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;isWord</span><span class="java_separator">(){...}</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>Although interpolation is pure text manipulation, the actual values
        supplied may be of any type, just as long as this type provides a
        reasonable <code class="code">toString()</code> method. (For simple types, the
        eponymous static method of the related class from <code class="code">java.lang</code>
        is used.)</p><p>Assuming that we have created a <code class="code">Collection&lt;ParamSet&gt;</code>
        for a template file <code class="code">template.drl</code>, we can now proceed to
        request its expansion.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_type">Collection</span><span class="java_operator">&lt;</span><span class="java_type">ParamSet</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;paramSets&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ArrayList</span><span class="java_operator">&lt;</span><span class="java_type">ParamSet</span><span class="java_operator">&gt;</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;populate&nbsp;paramSets</span>
<!--  --><br/><span class="java_plain">paramSets</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ParamSet</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Foo&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">42</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">paramSets</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ParamSet</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Bar&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">13</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">false</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">ObjectDataCompiler</span><span class="java_plain">&nbsp;converter&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ObjectDataCompiler</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">InputStream</span><span class="java_plain">&nbsp;templateStream&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">getClass</span><span class="java_separator">().</span><span class="java_plain">getResourceAsStream</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;template.drl&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;drl&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;converter</span><span class="java_separator">.</span><span class="java_plain">compile</span><span class="java_separator">(</span><span class="java_plain">&nbsp;objs</span><span class="java_separator">,</span><span class="java_plain">&nbsp;templateStream&nbsp;</span><span class="java_separator">);</span></pre>

        The resulting string contains the expanded rules text. You could
        write it to a file and proceed as usual, but it's also possible to
        feed this to a <code class="code">KnowledgeBuilder</code> and continue with the
        resulting Knowledge Packages.

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kBase&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBase</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">KnowledgeBuilder</span><span class="java_plain">&nbsp;kBuilder&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBuilderFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBuilder</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Reader</span><span class="java_plain">&nbsp;rdr&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">StringReader</span><span class="java_separator">(</span><span class="java_plain">&nbsp;drl&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">kBuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newReaderResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;rdr&nbsp;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DRL&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kBuilder</span><span class="java_separator">.</span><span class="java_plain">hasErrors</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">){</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">throw</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">IllegalStateException</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;DRL&nbsp;errors&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">kBase</span><span class="java_separator">.</span><span class="java_plain">addKnowledgePackages</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kBuilder</span><span class="java_separator">.</span><span class="java_plain">getKnowledgePackages</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span></pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e2124"/>2.5.2.2. Instantiation from Maps</h4></div></div></div><p>A <code class="code">Map</code> that provides the values for substituting
        template parameters should have a (string) key set matching all of
        the parameter names. Again, values could be from any class, as long
        as they provide a good <code class="code">toString()</code> method. The expansion
        would use the same approach, just differing in the way the
        map collection is composed.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_type">Collection</span><span class="java_operator">&lt;</span><span class="java_type">Map</span><span class="java_operator">&lt;</span><span class="java_type">String</span><span class="java_separator">,</span><span class="java_type">Object</span><span class="java_operator">&gt;&gt;</span><span class="java_plain">&nbsp;paramMaps&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ArrayList</span><span class="java_operator">&lt;</span><span class="java_type">Map</span><span class="java_operator">&lt;</span><span class="java_type">String</span><span class="java_separator">,</span><span class="java_type">Object</span><span class="java_operator">&gt;&gt;</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;populate&nbsp;paramMaps</span>
<!--  --><br/><span class="java_type">ObjectDataCompiler</span><span class="java_plain">&nbsp;converter&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ObjectDataCompiler</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">InputStream</span><span class="java_plain">&nbsp;templateStream&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">getClass</span><span class="java_separator">().</span><span class="java_plain">getResourceAsStream</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;template.drl&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;drl&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;converter</span><span class="java_separator">.</span><span class="java_plain">compile</span><span class="java_separator">(</span><span class="java_plain">&nbsp;objs</span><span class="java_separator">,</span><span class="java_plain">&nbsp;templateStream&nbsp;</span><span class="java_separator">);</span></pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e2137"/>2.5.3. Example</h3></div></div></div><p>The following example illustrates template expansion. It is based on simple
       objects of class <code class="code">Item</code> containing a couple of integer fields and an
       <code class="code">enum</code> field of type <code class="code">ItemCode</code>.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Item</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Item</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;n</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;p</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;w</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_plain">&nbsp;c&nbsp;</span><span class="java_separator">){...}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;&nbsp;&nbsp;getName</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{...}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getWeight</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{...}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getPrice</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{...}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_plain">&nbsp;getCode</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{...}</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;enum&nbsp;</span><span class="java_type">ItemCode</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;LOCK</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;STOCK</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;BARREL</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>The rule template contains a single rule. Notice that the field
         name for the range test is a parameter, which enables us to instantiate
         the template for different fields.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
template header
field
lower
upper
codes

package range;
template "inRange"
rule "is in range @{row.rowNumber}"
when
    Item( $name : name, $v : @{field} &gt;= @{lower} &amp;&amp; &lt;= @{upper}, $code : code @{codes} )
then
    System.out.println( "Item " + $name + " @{field} in range: " + $v + " code: " + $code );
end
end template</pre><p>The next code snippet is from the application, where several
         parameter sets have to be set up. First, there is class
         <code class="code">ParamSet</code>, for storing a set of actual parameters.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">ParamSet</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">EnumSet</span><span class="java_operator">&lt;</span><span class="java_type">ItemCode</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;codeSet</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">ParamSet</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;f</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;l</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;u</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">EnumSet</span><span class="java_operator">&lt;</span><span class="java_type">ItemCode</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;cs&nbsp;</span><span class="java_separator">){...}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getField</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;field</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;getLower</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;lower</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;getUpper</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;upper</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getCodes</span><span class="java_separator">(){</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">StringBuilder</span><span class="java_plain">&nbsp;sb&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">StringBuilder</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;conn&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">for</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_plain">&nbsp;ic</span><span class="java_operator">:</span><span class="java_plain">&nbsp;codeSet&nbsp;</span><span class="java_separator">){</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb</span><span class="java_separator">.</span><span class="java_plain">append</span><span class="java_separator">(</span><span class="java_plain">&nbsp;conn&nbsp;</span><span class="java_separator">).</span><span class="java_plain">append</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;&nbsp;==&nbsp;ItemCode.&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">).</span><span class="java_plain">append</span><span class="java_separator">(</span><span class="java_plain">&nbsp;ic&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;conn&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;&nbsp;||&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;sb</span><span class="java_separator">.</span><span class="java_plain">toString</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>Note that the method <code class="code">getCodes()</code> does returns the
        <code class="code">EnumSet&lt;ItemCode&gt;</code> field value as a <code class="code">String</code>
        value representing a multiple restriction, i.e., a test for one out
        of a list of values.</p><p>The task of expanding a template, passing the resulting DRL text
        to a Knowledge Builder and adding the resulting Knowledge Packages
        to a Knowledge Base is generic. The utility class <code class="code">Expander</code>
        takes care of this, using a Knowledge Base, the <code class="code">InputStream</code>
        with the rule template and the collection of parameter sets.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Expander</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;expand</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kBase</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">InputStream</span><span class="java_plain">&nbsp;is</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Collection</span><span class="java_operator">&lt;?&gt;</span><span class="java_plain">&nbsp;act&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">Exception</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ObjectDataCompiler</span><span class="java_plain">&nbsp;converter&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ObjectDataCompiler</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;drl&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;converter</span><span class="java_separator">.</span><span class="java_plain">compile</span><span class="java_separator">(</span><span class="java_plain">&nbsp;act</span><span class="java_separator">,</span><span class="java_plain">&nbsp;is&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeBuilder</span><span class="java_plain">&nbsp;kBuilder&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBuilderFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBuilder</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Reader</span><span class="java_plain">&nbsp;rdr&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">StringReader</span><span class="java_separator">(</span><span class="java_plain">&nbsp;drl&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kBuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newReaderResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;rdr&nbsp;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DRL&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kBuilder</span><span class="java_separator">.</span><span class="java_plain">hasErrors</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">){</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">for</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBuilderError</span><span class="java_plain">&nbsp;err</span><span class="java_operator">:</span><span class="java_plain">&nbsp;kBuilder</span><span class="java_separator">.</span><span class="java_plain">getErrors</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">){</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">err</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;err</span><span class="java_separator">.</span><span class="java_plain">toString</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">throw</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">IllegalStateException</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;DRL&nbsp;errors&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kBase</span><span class="java_separator">.</span><span class="java_plain">addKnowledgePackages</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kBuilder</span><span class="java_separator">.</span><span class="java_plain">getKnowledgePackages</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>We are now all set to prepare the Knowledge Base with some
        generated rules. First, we define several parameter sets,
        constructed as <code class="code">ParamSet</code> objects, and add them to a
        <code class="code">List</code>, which is passed to the <code class="code">expand</code>
        method shown above. Then we launch a stateful session, insert a
        few <code class="code">Item</code>, and watch what happens.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_type">Collection</span><span class="java_operator">&lt;</span><span class="java_type">ParamSet</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;cfl&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ArrayList</span><span class="java_operator">&lt;</span><span class="java_type">ParamSet</span><span class="java_operator">&gt;</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">cfl</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ParamSet</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;weight&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_literal">10</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_literal">99</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">EnumSet</span><span class="java_separator">.</span><span class="java_plain">of</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_separator">.</span><span class="java_plain">LOCK</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_separator">.</span><span class="java_plain">STOCK&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">cfl</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ParamSet</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;price&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_literal">10</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_literal">50</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">EnumSet</span><span class="java_separator">.</span><span class="java_plain">of</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_separator">.</span><span class="java_plain">BARREL&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kBase&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBase</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Expander</span><span class="java_plain">&nbsp;ex&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Expander</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">InputStream</span><span class="java_plain">&nbsp;dis&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">FileInputStream</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">File</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;rangeTemp.drl&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ex</span><span class="java_separator">.</span><span class="java_plain">expand</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kBase</span><span class="java_separator">,</span><span class="java_plain">&nbsp;dis</span><span class="java_separator">,</span><span class="java_plain">&nbsp;cfl&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_type">StatefulKnowledgeSession</span><span class="java_plain">&nbsp;session&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;kBase</span><span class="java_separator">.</span><span class="java_plain">newStatefulKnowledgeSession</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Item</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;A&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">130</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_literal">42</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_separator">.</span><span class="java_plain">LOCK&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Item</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;B&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_literal">44</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">100</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_separator">.</span><span class="java_plain">STOCK&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Item</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;C&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">123</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">180</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_separator">.</span><span class="java_plain">BARREL&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Item</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;D&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_literal">85</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_literal">9</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_separator">.</span><span class="java_plain">LOCK&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">fireAllRules</span><span class="java_separator">();</span></pre><p>Notice that the two resulting rules deal with
         <span class="emphasis"><em>different</em></span> fields, one with an item's weight,
         the other one with its price. - Below is the output.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
Item E price in range: 25 code: BARREL
Item A weight in range: 42 code: LOCK</pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e2208"/>2.6. More on building and deploying</h2></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e2211"/>2.6.1. Knowledge Base by Configuration Using Changesets</h3></div></div></div><p>So far, the programmatic API has been used to build a Knowledge
    Base. Quite often it's more desirable to do this via configuration. To
    facilitate this, Drools supports the "Changeset" feature. The file
    <code class="filename">changeset.xml</code> contains a list of resources, and it
    may also point recursively to another changeset XML file. Currently there is 
    no XML schema for the changeset XML, but we hope to add one soon.
    A few examples will be shown to give you the gist of things. A resource
    approach is employed that uses a prefix to indicate the protocol. All the
    protocols provided by <code class="code">java.net.URL</code>, such as "file" and "http",
    are supported, as well as an additional "classpath".
    Currently the type attribute must always be specified for a resource, as
    it is not inferred from the file name extension. Here is a simple example
    that points to a http location for some rules.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">change-set</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns:xs</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://www.w3.org/2001/XMLSchema-instance'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xs:schemaLocation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set&nbsp;http://anonsvn.jboss.org/repos/labs/labs/jbossrules/trunk/drools-api/src/main/resources/change-set-1.0.0.xsd'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">resource</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">source</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http:org/domain/myrules.drl'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'DRL'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">change-set</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>To use the above XML, the code is almost identical as before, except
    we change the resource type to <code class="code">CHANGE_SET</code>.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeBuilder</span><!-- <br/> --><span class="java_plain">&nbsp;kbuilder&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeBuilderFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeBuilder</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">kbuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newClasspathResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;myChangeSet.xml&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;getClass</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">CHANGE_SET&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">hasErrors</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">err</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;builder</span><span class="java_separator">.</span><span class="java_plain">getErrors</span><span class="java_separator">().</span><span class="java_plain">toString</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>Changesets can include any number of resources, and they even
    support additional configuration information, which currently is only
    needed for decision tables. The example below is expanded to load the
    rules from a http URL location, and an Excel decision table from the
    classpath.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">change-set</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns:xs</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://www.w3.org/2001/XMLSchema-instance'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xs:schemaLocation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set.xsd&nbsp;http://anonsvn.jboss.org/repos/labs/labs/jbossrules/trunk/drools-api/src/main/resources/change-set-1.0.0.xsd'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">resource</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">source</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http:org/domain/myrules.drl'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'DRL'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">resource</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">source</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'classpath:data/IntegrationExampleTest.xls'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;DTABLE&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">decisiontable-conf</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">input-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;XLS&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">worksheet-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Tables_2&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">resource</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">change-set</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>It is also possible to specify a directory, to add the contents of
    that directory. It is expected that all the files are of the specified
    type, since type is not yet inferred from the file name extensions.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">change-set</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns:xs</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://www.w3.org/2001/XMLSchema-instance'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xs:schemaLocation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set.xsd&nbsp;http://anonsvn.jboss.org/repos/labs/labs/jbossrules/trunk/drools-api/src/main/resources/change-set-1.0.0.xsd'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">resource</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">source</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'file://myfolder/'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'DRL'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">change-set</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e2239"/>2.6.2. Knowledge Agent</h3></div></div></div><p>The Knowledge Agent provides automatic loading, caching and
    re-loading of resources and is configured from a properties files. The
    Knowledge Agent can update or rebuild this Knowledge Base as the resources
    it uses are changed. The strategy for this is determined by the
    configuration given to the factory, but it is typically pull-based using
    regular polling. We hope to add push-based updates and rebuilds in future
    versions.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeAgent</span><!-- <br/> --><span class="java_plain">&nbsp;kagent&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeAgentFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeAgent</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;MyAgent&quot;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">kagent</span><span class="java_separator">.</span><span class="java_plain">applyChangeSet</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newUrlResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;url&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;kagent</span><span class="java_separator">.</span><span class="java_plain">getKnowledgeBase</span><span class="java_separator">();</span></pre><p>A <code class="code">KnowledgeAgent</code> object will continuously scan all the
    added resources, using a default polling interval of 60 seconds and, when
    some last modification date is updated, it will applied the changes into the
    cached Knowledge Base using the new resources. Note that the previous
    <code class="code">KnowledgeBase</code> reference will still exist and you'll have to
    call <code class="code">getKnowledgeBase()</code> to access the newly built
    <code class="code">KnowledgeBase</code>. If a directory is specified as part of the
    change set, the entire contents of that directory will be scanned for
    changes. The way modifications are applied depends on
    <code class="code">drools.agent.newInstance</code> property present in the
    KnowledgeAgentConfiguration object passed to the agent.
    </p><p>For polling to occur, the polling and notifier services must be started:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">ResourceFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getResourceChangeNotifierService</span><!-- <br/> --><span class="java_separator">().</span><!-- <br/> --><span class="java_plain">start</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">getResourceChangeScannerService</span><span class="java_separator">().</span><span class="java_plain">start</span><span class="java_separator">();</span></pre><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e2267"/>2.6.2.1. Knowledge Agent and Custom ClassLoaders</h4></div></div></div><p>Because Knowledge Agent could scan and process remote resources, it
      could ends up failing when compiling or executing rules, queries, functions,
      etc. that use classes outside the agent's classloader.
      If this is your case, you could take 2 approach: use a custom classloader
      for agent's kbuilder or force the agent to use the same classloader that
      its kbase has.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e2272"/>2.6.2.1.1. Custom ClassLoaders from KnowledgeBuilder</h5></div></div></div><p>Knowledge Agent uses KnowledgeBuilder internally in order to
        compile managed resources. If you need to pass custom configuration to
        these compilers you could pass a KnowledgeBuilderConfiguration object
        to KnowledgeAgentFactory.newKnowledgeAgent(). This object will be used
        in every builder the agent creates. Using a KnowledgeBuilderConfiguration
        you can specify a custom classloader.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Important</h2><p>The usage of a KnowledgeBuilder to specify the CL the agent
            must use is discouraged. See the next section for the best solution
            to this problem.</p></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>If the agent is handling binary resources (packages), then
            using a KnowledgeBuilder to specify the CL that must be used will
            not work. In this case the only solution is to pass a kbase that 
            uses the custom CL. See next section for more details.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e2283"/>2.6.2.1.2. Reuse KnowledgeBase ClassLoader</h5></div></div></div><p>Most of the times, the classloader you want to use in the
        compilation process of remote resources is the same needed in the
        agent's kbase, so the rules could be executed. If you want to use this
        approach, you will need to setup the desired ClassLoader to the
        agent kbase and use the "drools.agent.useKBaseClassLoaderForCompiling"
        property of KnowledgeAgentConfiguration object.</p><p>This approach lets you modify agent's kbuilder classloader in
        runtime by modifying the classloader the agent's kbase uses. This will
        serve also when not using incremental change set processing (see the
        section below). When the kbase is recreated its configuration is
        reused, so the classloader is maintained.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeBaseConfiguration</span><!-- <br/> --><span class="java_plain">&nbsp;kbaseConfig&nbsp;</span><!-- <br/> --><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBaseConfiguration</span><span class="java_separator">(</span><span class="java_literal">null</span><span class="java_separator">,</span><span class="java_plain">&nbsp;customClassLoader</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBase</span><span class="java_separator">(</span><span class="java_plain">kbaseConfig</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">kbase&nbsp;with&nbsp;custom&nbsp;classloader</span>
<!--  --><br/><span class="java_type">KnowledgeAgentConfiguration</span><span class="java_plain">&nbsp;aconf&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeAgentFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeAgentConfiguration</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">aconf</span><span class="java_separator">.</span><span class="java_plain">setProperty</span><span class="java_separator">(</span><span class="java_literal">&quot;drools.agent.newInstance&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;false&quot;</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">incremental&nbsp;change&nbsp;set&nbsp;processing&nbsp;enabled</span>
<!--  --><br/><span class="java_plain">aconf</span><span class="java_separator">.</span><span class="java_plain">setProperty</span><span class="java_separator">(</span><span class="java_literal">&quot;drools.agent.useKBaseClassLoaderForCompiling&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;true&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">KnowledgeAgent</span><span class="java_plain">&nbsp;kagent&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeAgentFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeAgent</span><span class="java_separator">(</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;test&nbsp;agent&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;kbase</span><span class="java_separator">,</span><span class="java_plain">&nbsp;aconf</span><span class="java_separator">);</span></pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e2292"/>2.6.2.2. Incremental Change Set Processing</h4></div></div></div><p>
            Knowledge Agent can process change sets in two different ways:
            recreating the knowledge base every time a new change set is
            processed or applying the change set in the cached knowledge base
            without destroying it.
            This behavior is controlled by the "newInstance" property of the
            KnowledgeAgentConfiguration object passed to the Agent's constructor.
        </p><p>
            When "newInstance" is set to true (the default value), the agent
            will destroy the cached Knowledge Base it contains and populate a
            new one containing the change set modifications. When "newInstance"
            is set to "false" change sets are applied directly to the cached
            Knowledge Base. The rule that were not modified in the change sets'
            resources are not replaced in the Knowledge Base, the modified or
            deleted rules are modified or deleted from the cached Knowledge Base.
            Functions, Queries and Definition Types are always replaced in the
            cached Knowledge Base whether they are modified or not.
        </p><p>
            The following code snippet creates a new Knowledge Agent with its
            "newInstance" property set to false
        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeAgentConfiguration</span><!-- <br/> --><span class="java_plain">&nbsp;aconf&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeAgentFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeAgentConfiguration</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">aconf</span><span class="java_separator">.</span><span class="java_plain">setProperty</span><span class="java_separator">(</span><span class="java_literal">&quot;drools.agent.newInstance&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;false&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">KnowledgeAgent</span><span class="java_plain">&nbsp;kagent&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeAgentFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeAgent</span><span class="java_separator">(</span><span class="java_literal">&quot;test&nbsp;agent&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">null</span><span class="java_separator">,</span><span class="java_plain">&nbsp;aconf</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e2303"/>2.6.2.3. Remote HTTP resource caching</h4></div></div></div><p>A note on remote HTTP Url Resources: if your knowledge agent is
    "pulling" resources from a http(s) URL, then you might rightly be
    concerned if that resource (remote web server) suddenly disappears. To
    survive a restart when a resource is no longer available remotely (eg the
    remote server is being restarted) then you can set a System Property:
    drools.resource.urlcache to a directory that has write permissions for the
    application: the Knowledge Agent will cache copies of the remote resources
    in that local directory. </p><p>For example, using the java command line:
    -Ddrools.resource.urlcache=/users/someone/KnowledgeCache - will keep local
    copies of the resources (rules, packages etc) in that directory, for the
    agent to use should it be restarted (when a remote resource becomes
    available, and is updated, it will automatically update the local cache
    copy). </p></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e2310"/>2.7. Logging</h2></div></div></div><p>One way to illuminate the black box that is a rule engine, is to play with the logging level.</p><p>Everything is logged to <a class="link" href="http://www.slf4j.org/" target="">SLF4J</a>, which is a simple logging facade
  that can delegate any log to Logback, Apache Commons Logging, Log4j or java.util.logging. Add a dependency to the
  logging adaptor for your logging framework of choice. If you're not using any logging framework yet, you can use
  Logback by adding this Maven dependency:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">ch.qos.logback</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">logback-classic</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">version</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">1.x</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">version</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>If you're developing for an ultra light environment, use <code class="literal">slf4j-nop</code> or
    <code class="literal">slf4j-simple</code> instead.</p></div><p>Configure the logging level on the package <code class="literal">org.drools</code>. For example:</p><p>In Logback, configure it in your <code class="filename">logback.xml</code> file:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">configuration</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">logger</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;org.drools&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">level</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;debug&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;...</span><br />
<span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">configuration</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>In Log4J, configure it in your <code class="filename">log4j.xml</code> file:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">log4j:configuration</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns:log4j</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://jakarta.apache.org/log4j/&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">category</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;org.drools&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">priority</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;debug&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">category</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;...</span><br />
<span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">log4j:configuration</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><ul xmlns:d="http://docbook.org/ns/docbook" class="docnav"><li class="previous"><a accesskey="p" href="ch01.html"><strong>Prev</strong>Chapter 1. Introduction</a></li><li class="up"><a accesskey="u" href="#"><strong>Top of page</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Front page</strong></a></li><li class="next"><a accesskey="n" href="ch03.html"><strong>Next</strong>Chapter 3. API Reference</a></li></ul></body></html>